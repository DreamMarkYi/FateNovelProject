# 章节节点位置编辑器使用说明

## 概述

章节节点位置编辑器 (`ChapterNodeEditor.vue`) 是一个可视化工具，用于配置和调整章节选择页面中节点的世界坐标位置。

## 访问方式

在浏览器中访问：`http://localhost:5173/chapter-editor`

或从代码中跳转：
```javascript
router.push('/chapter-editor')
```

## 主要功能

### 1. 🖱️ 节点拖动
- **拖动节点**：点击并拖动任意节点来调整其世界坐标位置
- **实时更新**：拖动时连接线会实时更新
- **坐标显示**：每个节点显示当前世界坐标 (X, Y)

### 2. 🎯 画布导航
- **拖动画布**：按住鼠标中键或在空白区域按住左键拖动画布
- **网格背景**：50px网格帮助对齐节点
- **重置视图**：点击"重置视图"按钮将相机居中到所有节点

### 3. 📝 详细编辑
- **选择节点**：点击节点或在侧边栏选择
- **手动输入**：在右侧面板直接输入精确的 X、Y 坐标
- **编辑属性**：修改节点名称、锁定状态等

### 4. 💾 保存配置
- **保存到后端**：点击"保存配置"按钮（需要后端API支持）
- **导出JSON**：点击"导出配置"下载配置文件到本地

### 5. 📤 导出配置
导出的 JSON 文件包含：
```json
{
  "nodes": [
    {
      "id": "node-1",
      "name": "第一章",
      "worldPosition": { "x": 500, "y": 400 },
      "locked": false,
      "connectNode": ["node-2"],
      "unlockConditions": []
    }
  ],
  "handwrittenNotes": [
    {
      "id": "note-1",
      "text": "keep going！！！",
      "worldPosition": { "x": 2500, "y": 800 },
      "rotation": 12,
      "scale": 1.1
    }
  ],
  "worldSize": {
    "width": 5000,
    "height": 3000
  }
}
```

## 界面布局

### 左侧栏 - 节点列表
- 显示所有节点的列表
- 点击选择节点
- 显示节点ID、名称、坐标
- 选中节点时显示详细信息面板

### 中央画布区域
- 可拖动的世界画布
- 网格背景辅助对齐
- 显示节点和连接线
- 底部显示相机坐标和光标世界坐标

### 顶部工具栏
- **返回**：返回上一页
- **保存配置**：保存到后端
- **导出配置**：下载JSON文件
- **重置视图**：相机居中
- **帮助**：显示使用说明

## 键盘快捷键

目前支持鼠标操作，后续可添加：
- `Ctrl + S`：快速保存
- `Space + 拖动`：平移画布
- `Delete`：删除选中节点
- `Ctrl + Z`：撤销
- `Ctrl + Y`：重做

## 节点样式说明

- **蓝色边框**：选中的节点
- **黄色边框**：锁定的节点
- **灰色边框**：普通节点
- **虚线连接**：节点之间的连接关系

## 数据持久化

### 方式1：后端API保存
需要实现以下API：
```javascript
// 在 novelScriptApi.js 中添加
updateNodePositions: async (configData) => {
  const response = await axios.put('/api/novel-scripts/positions', configData)
  return response.data
}
```

后端需要实现对应的接口来保存节点位置配置。

### 方式2：导出JSON文件
1. 点击"导出配置"按钮
2. 保存JSON文件到本地
3. 后续可以通过导入功能恢复配置

## 集成到现有页面

配置好的坐标数据可以直接用于 `ChapterSelectPage.vue`：

```javascript
// 在 ChapterSelectPage.vue 中
const nodes = ref([
  {
    id: 'node-1',
    name: '第一章',
    worldPosition: { x: 500, y: 400 }, // 使用编辑器配置的坐标
    locked: false,
    connectNode: ['node-2']
  }
])
```

## 注意事项

1. **世界坐标系统**：所有位置使用世界坐标，不受相机位置影响
2. **连接线自动更新**：移动节点时连接线会自动重新计算
3. **数据验证**：保存前确保所有节点坐标有效
4. **浏览器兼容性**：建议使用现代浏览器（Chrome、Firefox、Edge）

## 工作流程建议

1. **加载数据**：页面自动从后端加载当前节点配置
2. **调整布局**：拖动节点到合适的位置
3. **预览效果**：在编辑器中查看整体布局
4. **保存配置**：点击保存按钮或导出JSON
5. **测试验证**：返回章节选择页面查看实际效果

## 扩展功能（待实现）

- [ ] 批量操作多个节点
- [ ] 自动布局算法
- [ ] 网格吸附功能
- [ ] 撤销/重做历史
- [ ] 导入配置文件
- [ ] 节点连接线编辑
- [ ] 添加/删除节点
- [ ] 复制/粘贴节点
- [ ] 快捷键支持

## 故障排除

### 节点无法拖动
- 确保没有同时拖动画布
- 检查控制台是否有错误

### 保存失败
- 检查后端API是否正常运行
- 查看浏览器控制台错误信息
- 尝试使用导出功能作为备选方案

### 连接线显示异常
- 刷新页面重新加载数据
- 检查节点的 `connectNode` 配置

## 技术细节

- **框架**：Vue 3 Composition API
- **状态管理**：ref/reactive
- **拖动实现**：原生鼠标事件
- **坐标系统**：世界坐标 + 相机偏移
- **样式**：Scoped CSS

## 联系与支持

如有问题或建议，请查看项目文档或提交 Issue。

