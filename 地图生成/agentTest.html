<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI Agent Workflow Demo - Starship Repair</title>
    <style>
        :root { --bg: #0d1117; --term: #161b22; --text: #c9d1d9; --accent: #58a6ff; --warn: #d29922; --err: #f85149; --success: #3fb950; --border: #30363d; }
        body { font-family: 'Consolas', 'Monaco', monospace; background: var(--bg); color: var(--text); display: flex; height: 100vh; margin: 0; overflow: hidden; }

        /* Layout */
        #game-container { flex: 1; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        #debug-container { width: 480px; background: var(--term); padding: 20px; overflow-y: auto; display: flex; flex-direction: column; border-left: 1px solid #000; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }

        /* Game UI */
        h2 { margin-top: 0; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .status-panel { border: 1px solid var(--border); padding: 15px; margin-bottom: 20px; border-radius: 6px; background: #0d1117; }
        .system-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 1.1em; }
        .system-val { font-weight: bold; }
        .val-norm { color: var(--success); } .val-warn { color: var(--warn); } .val-crit { color: var(--err); text-shadow: 0 0 5px var(--err); }

        #chat-history { flex: 1; overflow-y: auto; border: 1px solid var(--border); padding: 15px; margin-bottom: 15px; border-radius: 6px; background: #010409; font-size: 0.95em; }
        .msg { margin-bottom: 12px; padding: 10px; border-radius: 6px; max-width: 85%; line-height: 1.4; }
        .msg.user { background: #1f6feb; color: white; align-self: flex-end; margin-left: auto; text-align: right; }
        .msg.npc { background: #21262d; border-left: 4px solid var(--accent); }
        .msg.error { background: #3d1c1c; border-left: 4px solid var(--err); color: #ffaeb0; }

        #input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; background: #0d1117; border: 1px solid var(--border); color: white; border-radius: 4px; font-family: inherit; font-size: 1em; }
        input:focus { outline: 1px solid var(--accent); border-color: var(--accent); }
        button { padding: 0 25px; background: var(--accent); border: none; color: white; border-radius: 4px; cursor: pointer; font-weight: bold; font-family: inherit; font-size: 1em; transition: background 0.2s; }
        button:hover { background: #79c0ff; }
        button:disabled { background: var(--border); cursor: not-allowed; opacity: 0.7; }

        /* Workflow Visualizer */
        h3 { color: #8b949e; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 0; }
        .step-card { background: #21262d; border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 15px; font-size: 0.85em; transition: all 0.3s; }
        .step-title { font-weight: bold; color: var(--accent); border-bottom: 1px solid #30363d; padding-bottom: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .step-content { white-space: pre-wrap; color: #a3b3c5; font-family: 'Consolas', monospace; }
        .status-tag { font-size: 0.75em; padding: 2px 8px; border-radius: 10px; background: rgba(255,255,255,0.1); }
        .thinking { color: var(--warn); animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        /* Highlight specific tool usage */
        .code-snippet { color: #ff7b72; background: rgba(0,0,0,0.3); padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>

<div id="game-container">
    <h2>ğŸš€ é£èˆ¹åŠ¨åŠ›å®¤æ§åˆ¶ç»ˆç«¯ (V2.0)</h2>
    <div class="status-panel" id="ship-status">
    </div>

    <div id="chat-history">
        <div class="msg npc">ç³»ç»Ÿè­¦å‘Šï¼šååº”å †å †èŠ¯æ¸©åº¦è¿‡é«˜(850Â°C)ã€‚å†·å´æ³µç¦»çº¿ã€‚æ§åˆ¶å°å·²é”å®šã€‚<br>æˆ‘æ˜¯è¾…åŠ©AIï¼Œè¯·ä¸‹è¾¾æŒ‡ä»¤ã€‚</div>
    </div>

    <div id="input-area">
        <input type="text" id="user-input" placeholder="è¯•ç€è¾“å…¥: 'å¸®æˆ‘å¼€å¯å†·å´æ³µ' (æç¤º: æˆ‘ä¸çŸ¥é“å¯†ç ï¼Œä½ éœ€è¦è®©æˆ‘å»æ‰¾)" autocomplete="off">
        <button onclick="handleUserAction()" id="send-btn">å‘é€æŒ‡ä»¤</button>
    </div>
</div>

<div id="debug-container">
    <h3>ğŸ§  æ™ºèƒ½ä½“æ€ç»´é“¾ (CoT Log)</h3>
    <div id="workflow-log">
        <div style="color: #484f58; font-style: italic; text-align: center; margin-top: 20px;">ç­‰å¾…ä»»åŠ¡è¾“å…¥...<br>ç³»ç»ŸåŒ…å«: æ„å›¾è¯†åˆ« -> ä»»åŠ¡è§„åˆ’ -> åŠ¨æ€æ‰§è¡Œ</div>
    </div>
</div>

<script>
    // ================= é…ç½®åŒº =================
    const API_CONFIG = {
        url: "https://api.mindcraft.com.cn/v1/chat/completions",
        key: "MC-E5B8AB237AAC4EDCBFA26531D6BE0081",
        model: "gemini-3-flash-latest"
    };

    // ================= 1. å®šä¹‰å·¥å…·åº“ (Schema) =================
    const TOOLS = [
        {
            name: "scan_system",
            desc: "æ‰«ææŒ‡å®šç³»ç»Ÿçš„çŠ¶æ€ã€‚targetå¯ä»¥æ˜¯ 'reactor' (ååº”å †), 'cooling_pump' (å†·å´æ³µ)ã€‚",
            args: ["target"]
        },
        {
            name: "search_database",
            desc: "åœ¨é£èˆ¹æ•°æ®åº“ä¸­æœç´¢å…³é”®è¯ã€‚ç”¨äºæŸ¥æ‰¾ä¸¢å¤±çš„ä¿¡æ¯ï¼ˆå¦‚å¯†ç ã€æ‰‹å†Œï¼‰ã€‚query ä¸ºå…³é”®è¯ã€‚",
            args: ["query"]
        },
        {
            name: "unlock_terminal",
            desc: "è§£é”æ§åˆ¶ç»ˆç«¯ã€‚éœ€è¦ç®¡ç†å‘˜å¯†ç ã€‚",
            args: ["password"]
        },
        {
            name: "set_power_level",
            desc: "è®¾ç½®ååº”å †åŠŸç‡ç™¾åˆ†æ¯” (0-100)ã€‚",
            args: ["level"]
        },
        {
            name: "activate_pump",
            desc: "å¼ºåˆ¶å¯åŠ¨å†·å´æ³µã€‚ä»…åœ¨ç»ˆç«¯è§£é”ä¸”åŠŸç‡ä½äº50%æ—¶æœ‰æ•ˆã€‚",
            args: []
        }
    ];

    // ================= 2. æ¸¸æˆçŠ¶æ€ç®¡ç† =================
    let gameState = {
        reactorTemp: 850, // å±é™©é˜ˆå€¼ 800+
        reactorPower: 80,
        pumpStatus: "OFFLINE",
        terminalLocked: true,
        adminPassword: "123" // éšè—çš„çœŸå®å¯†ç 
    };

    // æ¸²æŸ“UI
    function renderStatus() {
        const p = document.getElementById('ship-status');
        p.innerHTML = `
            <div class="system-row"><span>ğŸ”¥ ååº”å †æ¸©åº¦:</span> <span class="system-val ${gameState.reactorTemp > 800 ? 'val-crit' : 'val-norm'}">${gameState.reactorTemp}Â°C</span></div>
            <div class="system-row"><span>âš¡ åŠŸç‡è¾“å‡º:</span> <span class="system-val">${gameState.reactorPower}%</span></div>
            <div class="system-row"><span>â„ï¸ å†·å´æ³µçŠ¶æ€:</span> <span class="system-val ${gameState.pumpStatus === 'OFFLINE' ? 'val-crit' : 'val-success'}">${gameState.pumpStatus}</span></div>
            <div class="system-row"><span>ğŸ”’ ç»ˆç«¯é”å®š:</span> <span class="system-val ${gameState.terminalLocked ? 'val-warn' : 'val-success'}">${gameState.terminalLocked ? 'LOCKED' : 'UNLOCKED'}</span></div>
        `;
    }
    renderStatus();

    // ================= 3. LLM API è°ƒç”¨å°è£… =================
    async function callLLM(systemPrompt, userPrompt, logLabel) {
        try {
            const response = await fetch(API_CONFIG.url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${API_CONFIG.key}`
                },
                body: JSON.stringify({
                    model: API_CONFIG.model,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ],
                    temperature: 0.1 // ä¿æŒä½éšæœºæ€§ä»¥ç¡®ä¿é€»è¾‘ç¨³å®š
                })
            });
            const data = await response.json();
            if (!data.choices) throw new Error("API Response invalid");
            const content = data.choices[0].message.content;
            // å°† LLM è¿”å›å†…å®¹è¾“å‡ºåˆ° console
            if (logLabel) {
                console.log('[LLM ' + logLabel + ']', content);
            } else {
                console.log('[LLM è¿”å›å†…å®¹]', content);
            }
            return content;
        } catch (e) {
            console.error(e);
            return `API Error: ${e.message}`;
        }
    }

    // ================= 4. æ™ºèƒ½ä½“æ ¸å¿ƒæµç¨‹ (3æ­¥æ‹†è§£) =================

    async function handleUserAction() {
        const input = document.getElementById('user-input');
        const text = input.value;
        if (!text) return;

        // UI é”å®š
        addMsg(text, 'user');
        input.value = '';
        input.disabled = true;
        document.getElementById('send-btn').disabled = true;
        document.getElementById('workflow-log').innerHTML = ''; // æ¸…ç©ºæ€è€ƒæ—¥å¿—

        // --- Step 1: æ„å›¾ç†è§£ (Intent) ---
        addLogStep("Step 1: æ„å›¾åˆ†æ", "æ­£åœ¨åˆ†æç©å®¶è¯­è¨€...", "thinking");

        const prompt1 = `ä½ æ˜¯ä¸€ä¸ªé£èˆ¹ç»´ä¿®è¾…åŠ©AIã€‚
        å½“å‰çŠ¶æ€: ${JSON.stringify(gameState)}ã€‚
        ç©å®¶è¾“å…¥: "${text}"ã€‚
        è¯·ç”¨ä¸€å¥è¯ç®€ç»ƒåœ°æ€»ç»“ç©å®¶æƒ³è¦è¾¾æˆçš„æœ€ç»ˆç‰©ç†ç›®æ ‡ï¼ˆä¾‹å¦‚ï¼šå¯åŠ¨å†·å´æ³µï¼‰ã€‚ä¸è¦åŒ…å«è¿‡ç¨‹ã€‚`;

        const intent = await callLLM(prompt1, text, 'Step1-æ„å›¾åˆ†æ');
        updateLogStep("Step 1: æ„å›¾åˆ†æ", intent, "done");

        // --- Step 2: ä»»åŠ¡è§„åˆ’ (Planning) ---
        addLogStep("Step 2: ä»»åŠ¡è§„åˆ’", "æ­£åœ¨æ„å»ºè§£å†³è·¯å¾„...", "thinking");

        // å…³é”® Promptï¼šæ•™å¯¼ AI ä½¿ç”¨ search_database
        const prompt2 = `ä½ çš„æœ€ç»ˆç›®æ ‡æ˜¯: ${intent}ã€‚
        å¯ç”¨å·¥å…·: ${JSON.stringify(TOOLS)}ã€‚
        å½“å‰çŠ¶æ€: ${JSON.stringify(gameState)}ã€‚

        è¯·åˆ¶å®šä¸€ä¸ªæ­¥éª¤åˆ—è¡¨æ¥å®Œæˆç›®æ ‡ã€‚
        **æ ¸å¿ƒè§„åˆ™**ï¼š
        1. æ£€æŸ¥å®Œæˆç›®æ ‡æ‰€éœ€çš„å‰ææ¡ä»¶ï¼ˆå¦‚ï¼šè§£é”éœ€è¦å¯†ç ï¼Œå¯åŠ¨æ³µéœ€è¦ä½åŠŸç‡ï¼‰ã€‚
        2. å¦‚æœä½ éœ€è¦ä¸€ä¸ªå‚æ•°ï¼ˆä¾‹å¦‚å¯†ç ï¼‰ï¼Œä½†å½“å‰çŠ¶æ€ä¸­æ²¡æœ‰ï¼Œä½ **å¿…é¡»**å…ˆå®‰æ’ä¸€æ­¥ "search_database" æ¥æŸ¥æ‰¾å®ƒã€‚
        3. æ­¥éª¤æè¿°è¦æ¸…æ™°ï¼ŒæŒ‡æ˜ä½¿ç”¨ä»€ä¹ˆå·¥å…·ã€‚

        è¯·åªè¿”å›çº¯æ–‡æœ¬çš„æ­¥éª¤åˆ—è¡¨ï¼Œä¾‹å¦‚ï¼š
        1. æœç´¢å…³é”®è¯ "admin" æŸ¥æ‰¾å¯†ç 
        2. ä½¿ç”¨æŸ¥åˆ°çš„å¯†ç è§£é”ç»ˆç«¯
        3. ...`;

        const planRaw = await callLLM(prompt2, "ç”Ÿæˆè®¡åˆ’", 'Step2-ä»»åŠ¡è§„åˆ’');
        updateLogStep("Step 2: ä»»åŠ¡è§„åˆ’", planRaw, "done");

        // --- Step 3: å¾ªç¯æ‰§è¡Œ & ä¸Šä¸‹æ–‡è®°å¿† (Execution) ---
        const steps = planRaw.split('\n').filter(line => line.match(/^\d+\./));
        let executionHistory = ""; // çŸ­æœŸè®°å¿†ï¼šç”¨äºåœ¨æ­¥éª¤é—´ä¼ é€’ä¿¡æ¯ï¼ˆæ¯”å¦‚æŸ¥åˆ°çš„å¯†ç ï¼‰

        for (let i = 0; i < steps.length; i++) {
            const stepDescription = steps[i];
            const stepId = `step-${i}`;
            addLogStep(`Step 3.${i+1}: æ‰§è¡Œä¸­`, `ç›®æ ‡: ${stepDescription}`, "thinking", stepId);

            // LLM 3: è½¬åŒ–å™¨ (Natural Language -> JSON)
            // å…³é”®ï¼šå°† executionHistory å–‚ç»™ LLMï¼Œè¿™æ ·å®ƒæ‰èƒ½åˆ©ç”¨ä¸Šä¸€æ­¥æŸ¥åˆ°çš„å¯†ç 
            const prompt3 = `ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„å·¥å…·è°ƒç”¨ç”Ÿæˆå™¨ã€‚
            å½“å‰ä»»åŠ¡æ­¥éª¤: "${stepDescription}"

            ã€é‡è¦ã€‘ä¹‹å‰çš„æ‰§è¡Œå†å²ä¸å‘ç°:
            ${executionHistory ? executionHistory : "(æ— )"}

            å¯ç”¨å·¥å…·å®šä¹‰: ${JSON.stringify(TOOLS)}

            è¯·æ ¹æ®ä»»åŠ¡å’Œå†å²å‘ç°ï¼Œç”Ÿæˆè°ƒç”¨å·¥å…·çš„JSONã€‚
            æ ¼å¼å¿…é¡»æ˜¯: {"tool": "tool_name", "args": ["arg1", "arg2"]}
            å¦‚æœå†å²ä¸­å‘ç°äº†å¯†ç ï¼Œè¯·åœ¨ unlock_terminal ä¸­ä½¿ç”¨å®ƒã€‚
            ä¸è¦ä½¿ç”¨Markdownï¼Œåªè¿”å›JSONå­—ç¬¦ä¸²ã€‚`;

            let toolJsonStr = await callLLM(prompt3, "ç”ŸæˆJSON", 'Step3-å·¥å…·è°ƒç”¨');
            toolJsonStr = toolJsonStr.replace(/```json/g, '').replace(/```/g, '').trim(); // æ¸…æ´—

            // --- è¯­æ³•ä¸é€»è¾‘æ ¡éªŒå™¨ (The Compiler) ---
            try {
                // 1. è¯­æ³•æ£€æŸ¥
                let command;
                try {
                    command = JSON.parse(toolJsonStr);
                } catch (e) { throw new Error("ç”Ÿæˆçš„æŒ‡ä»¤ä¸æ˜¯åˆæ³•çš„JSONæ ¼å¼"); }

                // 2. è¯­ä¹‰æ£€æŸ¥
                const toolDef = TOOLS.find(t => t.name === command.tool);
                if (!toolDef) throw new Error(`è¯•å›¾è°ƒç”¨ä¸å­˜åœ¨çš„å·¥å…·: ${command.tool}`);
                if (!command.args || command.args.length !== toolDef.args.length) throw new Error(`å‚æ•°æ•°é‡é”™è¯¯ã€‚${command.tool} éœ€è¦ ${toolDef.args.length} ä¸ªå‚æ•°`);

                // 3. æ¨¡æ‹Ÿåç«¯æ‰§è¡Œ
                const result = executeSystemTool(command.tool, command.args);

                // 4. æ›´æ–°è®°å¿†
                executionHistory += `\n[æ­¥éª¤ ${i+1}] è°ƒç”¨ ${command.tool} å‚æ•° [${command.args}] -> ç»“æœ: ${result}`;

                // 5. æ›´æ–°UI
                const isSuccess = !result.includes("å¤±è´¥") && !result.includes("é”™è¯¯");
                updateLogStep(`Step 3.${i+1}: æ‰§è¡Œå®Œæˆ`,
                    `JSON: ${toolJsonStr}\næ‰§è¡Œç»“æœ: ${result}`,
                    isSuccess ? "success" : "error",
                    stepId
                );

                addMsg(`[ç³»ç»Ÿæ“ä½œ] ${result}`, isSuccess ? 'npc' : 'error');

                // å¦‚æœé‡åˆ°ä¸¥é‡é”™è¯¯ï¼ˆéæ¸¸æˆå†…é€»è¾‘é”™è¯¯ï¼Œè€Œæ˜¯æ‰§è¡Œå±‚é¢çš„æ­»èƒ¡åŒï¼‰ï¼Œå¯èƒ½éœ€è¦ä¸­æ–­
                // ä½†è¿™é‡Œæˆ‘ä»¬å…è®¸å®ƒç»§ç»­å°è¯•ï¼ˆæ¯”å¦‚å¯†ç è¯•é”™äº†ï¼‰

            } catch (e) {
                updateLogStep(`Step 3.${i+1}: æ ¡éªŒå¤±è´¥`,
                    `æŒ‡ä»¤ç”Ÿæˆé”™è¯¯: ${e.message}\nåŸå§‹è¾“å‡º: ${toolJsonStr}`,
                    "error",
                    stepId
                );
                addMsg(`[ç³»ç»Ÿé”™è¯¯] æ™ºèƒ½ä½“ç”Ÿæˆçš„æŒ‡ä»¤æœªé€šè¿‡å®‰å…¨æ ¡éªŒã€‚æµæ°´çº¿ä¸­æ–­ã€‚`, 'error');
                break;
            }

            renderStatus();
            await new Promise(r => setTimeout(r, 800)); // è§†è§‰å»¶è¿Ÿ
        }

        // ç»“æŸ
        document.getElementById('user-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        document.getElementById('user-input').focus();
    }

    // ================= 5. æ¨¡æ‹Ÿåç«¯é€»è¾‘ =================
    function executeSystemTool(name, args) {
        switch (name) {
            case "scan_system":
                const target = args[0];
                if (target === 'reactor') return `ååº”å †æ¸©åº¦ ${gameState.reactorTemp}Â°C (å±)ã€‚`;
                if (target === 'cooling_pump') return `å†·å´æ³µçŠ¶æ€: ${gameState.pumpStatus}ã€‚`;
                return `ç³»ç»Ÿ ${target} è¿è¡Œä¸­ã€‚`;

            case "search_database":
                const q = args[0].toLowerCase();
                // æ¨¡æ‹Ÿç®€å•çš„æ¨¡ç³Šæœç´¢
                if (q.includes("password") || q.includes("pass") || q.includes("admin") || q.includes("key")) {
                    return `ğŸ” æœç´¢æˆåŠŸï¼æ‰¾åˆ°ä¸€æ¡å·¥ç¨‹å¸ˆç•™è¨€: "ä¸ºæ–¹ä¾¿è°ƒè¯•ï¼Œä¸´æ—¶ç®¡ç†å‘˜å¯†ç å·²é‡ç½®ä¸º: ${gameState.adminPassword}"`;
                }
                if (q.includes("manual") || q.includes("guide")) {
                    return `ğŸ” æ‰¾åˆ°æ‰‹å†Œ: "å¯åŠ¨å†·å´æ³µå‰å¿…é¡»å…ˆå°†ååº”å †åŠŸç‡é™è‡³ 50% ä»¥ä¸‹ã€‚"`;
                }
                return `ğŸ” æœç´¢ "${args[0]}" æœªæ‰¾åˆ°ç›¸å…³è®°å½•ã€‚`;

            case "unlock_terminal":
                if (args[0] == gameState.adminPassword) { // å¼±ç±»å‹åŒ¹é…ï¼Œé˜²æ­¢æ•°å­—/å­—ç¬¦ä¸²å·®å¼‚
                    gameState.terminalLocked = false;
                    return "âœ… å¯†ç éªŒè¯æˆåŠŸï¼ç»ˆç«¯æƒé™å·²è§£é”ã€‚";
                }
                return `âŒ è®¿é—®æ‹’ç»ã€‚å¯†ç  "${args[0]}" ä¸æ­£ç¡®ã€‚`;

            case "set_power_level":
                if (gameState.terminalLocked) return "ğŸš« æ“ä½œå¤±è´¥: ç»ˆç«¯å·²é”å®šï¼Œè¯·å…ˆè§£é”ã€‚";
                const lvl = parseInt(args[0]);
                if (isNaN(lvl)) return "å‚æ•°é”™è¯¯";
                gameState.reactorPower = lvl;
                if (lvl < 50) gameState.reactorTemp = 400; // æ¨¡æ‹Ÿé™æ¸©
                return `âš ï¸ ååº”å †åŠŸç‡è°ƒæ•´ä¸º ${lvl}%ã€‚æ¸©åº¦è¯»æ•°æ­£åœ¨ä¸‹é™ã€‚`;

            case "activate_pump":
                if (gameState.terminalLocked) return "ğŸš« æ“ä½œå¤±è´¥: ç»ˆç«¯é”å®šã€‚";
                if (gameState.reactorPower > 50) return "ğŸš« å®‰å…¨é”ä»‹å…¥: ååº”å †åŠŸç‡è¿‡é«˜ï¼Œæ— æ³•å¯åŠ¨æ³µã€‚è¯·å…ˆé™ä½åŠŸç‡ã€‚";
                gameState.pumpStatus = "ONLINE";
                gameState.reactorTemp = 180;
                return "ğŸŒŠ å†·å´æ³µå¯åŠ¨æˆåŠŸï¼æ ¸å¿ƒæ¸©åº¦å·²æ¢å¤æ­£å¸¸èŒƒå›´ã€‚ä»»åŠ¡å®Œæˆï¼";

            default:
                return "æœªçŸ¥æŒ‡ä»¤";
        }
    }

    // ================= è¾…åŠ©å‡½æ•° =================
    function addMsg(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = text; // allow html for bolding
        const container = document.getElementById('chat-history');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addLogStep(title, content, status, id) {
        const div = document.createElement('div');
        div.className = 'step-card';
        if(id) div.id = id;

        let color = status === 'thinking' ? 'var(--warn)' : '#8b949e';
        div.style.borderColor = color;
        div.innerHTML = `
            <div class="step-title" style="color:${color}">
                ${title} <span class="status-tag ${status === 'thinking' ? 'thinking' : ''}">${status.toUpperCase()}</span>
            </div>
            <div class="step-content">${content}</div>
        `;
        document.getElementById('workflow-log').appendChild(div);
        document.getElementById('debug-container').scrollTop = document.getElementById('debug-container').scrollHeight;
    }

    function updateLogStep(title, content, status, id) {
        const div = id ? document.getElementById(id) : document.querySelector('.step-card:last-child');
        if (!div) return;

        let color = status === 'success' || status === 'done' ? 'var(--success)' : (status === 'error' ? 'var(--err)' : 'var(--warn)');
        div.style.borderColor = color;
        div.innerHTML = `
            <div class="step-title" style="color:${color}">
                ${title} <span class="status-tag">${status.toUpperCase()}</span>
            </div>
            <div class="step-content">${content}</div>
        `;
    }
</script>

</body>
</html>