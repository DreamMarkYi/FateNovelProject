<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ä¹°ç³»ç»Ÿå®Œæ•´æ¼”ç¤º</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="knowledge5-assets/js/worldgen-llm.js"></script>
    <script src="knowledge5-assets/js/item-filter-llm.js"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --accent-color: #00d4ff;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #8b949e;
            margin-bottom: 30px;
        }

        .section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            color: var(--accent-color);
            font-size: 1.2em;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title .step-number {
            background: var(--accent-color);
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px;
            background: #0d1117;
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .two-columns {
                grid-template-columns: 1fr;
            }
        }

        button {
            padding: 12px 24px;
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        button:hover:not(:disabled) {
            box-shadow: 0 0 15px var(--accent-color);
            transform: translateY(-1px);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        .llm-output {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #333;
            margin-bottom: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .item-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            padding: 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .item-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .item-card.selected {
            border-color: var(--success-color);
            background: rgba(76, 175, 80, 0.1);
        }

        .item-card h4 {
            margin: 0 0 10px 0;
            color: #fff;
            font-size: 1em;
        }

        .item-card .price {
            color: var(--warning-color);
            font-weight: bold;
            font-size: 1.1em;
        }

        .item-card .base-price {
            color: #888;
            font-size: 0.9em;
            text-decoration: line-through;
            margin-right: 8px;
        }

        .item-card .price-modifier {
            font-size: 0.8em;
            color: var(--accent-color);
            margin-top: 5px;
        }

        .upload-section {
            background: rgba(0, 212, 255, 0.05);
            border: 1px dashed var(--accent-color);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .btn-upload {
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            background-color: transparent;
            padding: 8px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            width: auto;
        }

        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .filtered-items-section {
            margin-top: 15px;
        }

        .filtered-item {
            background: rgba(0, 212, 255, 0.1);
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .purchase-summary {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--success-color);
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .purchase-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .remove-btn {
            background: var(--error-color);
            padding: 5px 10px;
            font-size: 0.8em;
            width: auto;
        }

        .total-price {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--warning-color);
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }

        .player-money {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 152, 0, 0.1);
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
        }

        .status-error {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error-color);
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ›’ è´­ä¹°ç³»ç»Ÿå®Œæ•´æ¼”ç¤º</h1>
    <p class="subtitle">å±•ç¤ºç‰©å“è¿‡æ»¤ â†’ å®šä»· â†’ è´­ä¹°ç»“ç®—çš„å®Œæ•´æµç¨‹</p>

    <!-- CSVä¸Šä¼  -->
    <div class="upload-section">
        <p style="margin-top:0; color:#8b949e">ç¬¬ä¸€æ­¥ï¼šåŠ è½½ç‰©å“æ¸…å• (CSV)</p>
        <div class="upload-btn-wrapper">
            <button class="btn-upload">é€‰æ‹© CSV æ–‡ä»¶</button>
            <input type="file" id="csvFileInput" accept=".csv" />
        </div>
        <div id="fileInfo" style="margin-top:10px; font-size:0.9em; color:#fff;"></div>
    </div>

    <!-- è¾“å…¥è¡¨å• -->
    <div class="section">
        <div class="section-title">
            <span class="step-number">0</span>
            <span>ğŸ“ æµ‹è¯•å‚æ•°</span>
        </div>

        <div class="form-group">
            <label>ç©å®¶æŸ¥è¯¢ï¼š</label>
            <input type="text" id="userQuery" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³ä¹°ä¸€æŠŠæª" value="æˆ‘æƒ³ä¹°ä¸€æŠŠæª" />
        </div>

        <div class="two-columns">
            <div>
                <div class="form-group">
                    <label>NPCåç§°ï¼š</label>
                    <input type="text" id="npcName" value="é»‘å¸‚æ­¦å™¨å•†" />
                </div>
                <div class="form-group">
                    <label>NPCèŒä¸šï¼š</label>
                    <input type="text" id="npcOccupation" value="é»‘å¸‚æ­¦å™¨å•†" />
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>NPCæ€§æ ¼ï¼š</label>
                    <input type="text" id="npcPersonality" value="è°¨æ…" />
                </div>
                <div class="form-group">
                    <label>NPCæè¿°ï¼š</label>
                    <textarea id="npcDesc">ä¸€ä¸ªç¥ç§˜çš„é»‘å¸‚æ­¦å™¨å•†äººï¼Œä¸“é—¨å‡ºå”®è¿ç¦æ­¦å™¨</textarea>
                </div>
            </div>
        </div>

        <div class="two-columns">
            <div class="form-group">
                <label>ç©å®¶é‡‘é’±ï¼ˆä¿¡ç”¨ç‚¹ï¼‰ï¼š</label>
                <input type="number" id="playerMoney" value="1000" min="0" />
            </div>
            <div class="form-group">
                <label>ç©å®¶ç¤¾ä¼šçŠ¶æ€ï¼š</label>
                <input type="text" id="playerSocial" value="æ™®é€š" />
            </div>
        </div>

        <button onclick="startProcess()" id="processBtn">
            <span id="btnText">ğŸš€ å¼€å§‹å¤„ç†</span>
            <div class="loader" id="loader"></div>
        </button>
    </div>

    <!-- LLM #1 è¾“å‡º -->
    <div class="section" id="llm1Section" style="display:none;">
        <div class="section-title">
            <span class="step-number">1</span>
            <span>ğŸ¤– LLM #1: ç‰©å“è¿‡æ»¤LLM</span>
        </div>
        <div style="margin-bottom:10px; color:#8b949e;">å°†è‡ªç„¶è¯­è¨€æŸ¥è¯¢è½¬æ¢ä¸ºè¿‡æ»¤æ¡ä»¶</div>

        <div style="margin-bottom:10px;">
            <strong>æ€ç»´é“¾æ¨ç†è¿‡ç¨‹ï¼š</strong>
        </div>
        <div class="llm-output" id="llm1Thinking">ç­‰å¾…ä¸­...</div>

        <div style="margin-top:15px; margin-bottom:10px;">
            <strong>è¿‡æ»¤é€»è¾‘JSONï¼š</strong>
        </div>
        <div class="llm-output" id="llm1Filters">ç­‰å¾…ä¸­...</div>

        <div class="filtered-items-section" id="filteredItemsSection" style="display:none;">
            <div style="margin-top:15px; margin-bottom:10px;">
                <strong>è¿‡æ»¤åçš„ç‰©å“åˆ—è¡¨ï¼š</strong>
            </div>
            <div class="items-grid" id="filteredItemsGrid"></div>
        </div>
    </div>

    <!-- LLM #2 è¾“å‡º -->
    <div class="section" id="llm2Section" style="display:none;">
        <div class="section-title">
            <span class="step-number">2</span>
            <span>ğŸ’¼ LLM #2: å•†äººå®šä»·LLM</span>
        </div>
        <div style="margin-bottom:10px; color:#8b949e;">ä¸ºæ¯ä¸ªç‰©å“è®¡ç®—åŠ¨æ€ä»·æ ¼</div>

        <div style="margin-bottom:10px;">
            <strong>æ€ç»´é“¾æ¨ç†è¿‡ç¨‹ï¼š</strong>
        </div>
        <div class="llm-output" id="llm2Thinking">ç­‰å¾…ä¸­...</div>

        <div style="margin-top:15px; margin-bottom:10px;">
            <strong>å®šä»·ç»“æœJSONï¼š</strong>
        </div>
        <div class="llm-output" id="llm2Pricing">ç­‰å¾…ä¸­...</div>
    </div>

    <!-- ç‰©å“é€‰æ‹©ç•Œé¢ -->
    <div class="section" id="itemSelectionSection" style="display:none;">
        <div class="section-title">
            <span class="step-number">3</span>
            <span>ğŸ›ï¸ é€‰æ‹©è¦è´­ä¹°çš„ç‰©å“</span>
        </div>

        <div class="player-money">
            <span>ğŸ’° å½“å‰é‡‘é’±ï¼š<strong id="currentMoney">1000</strong> ä¿¡ç”¨ç‚¹</span>
            <span id="moneyStatus"></span>
        </div>

        <div class="items-grid" id="pricedItemsGrid"></div>
    </div>

    <!-- è´­ä¹°ç»“ç®— -->
    <div class="section" id="purchaseSection" style="display:none;">
        <div class="section-title">
            <span class="step-number">4</span>
            <span>ğŸ’³ è´­ä¹°ç»“ç®—</span>
        </div>

        <div class="purchase-summary">
            <div style="margin-bottom:15px; font-weight:bold; color:#fff;">å·²é€‰æ‹©çš„ç‰©å“ï¼š</div>
            <div id="selectedItemsList"></div>
            <div class="total-price">
                <div>æ€»ä»·ï¼š<span id="totalPrice">0</span> ä¿¡ç”¨ç‚¹</div>
                <div style="font-size:0.9em; color:#8b949e; margin-top:5px;">
                    å‰©ä½™ï¼š<span id="remainingMoney">1000</span> ä¿¡ç”¨ç‚¹
                </div>
            </div>
            <button onclick="confirmPurchase()" id="confirmBtn" style="margin-top:15px;">
                ç¡®è®¤è´­ä¹°
            </button>
        </div>
    </div>

    <!-- è´­ä¹°ç»“æœ -->
    <div class="section" id="resultSection" style="display:none;">
        <div class="section-title">
            <span class="step-number">âœ“</span>
            <span>âœ… è´­ä¹°å®Œæˆ</span>
        </div>
        <div id="purchaseResult"></div>
    </div>
</div>

<script>
    let itemFilter = null;
    let filteredItems = [];
    let pricedItems = [];
    let selectedItems = [];
    let playerMoney = 1000;

    // CSVæ–‡ä»¶ä¸Šä¼ 
    document.getElementById('csvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('fileInfo').textContent = `æ­£åœ¨è¯»å–: ${file.name}...`;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    itemFilter = new ItemFilterLLM();
                    itemFilter.processCSVData(results.data);
                    document.getElementById('fileInfo').textContent = `âœ… æˆåŠŸåŠ è½½: ${file.name} (${results.data.length} æ¡æ•°æ®)`;
                    document.getElementById('processBtn').disabled = false;
                } else {
                    alert("CSV æ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯");
                }
            },
            error: function(err) {
                alert("è§£æé”™è¯¯: " + err.message);
            }
        });
    });

    async function startProcess() {
        if (!itemFilter) {
            alert("è¯·å…ˆåŠ è½½ CSV æ•°æ®ï¼");
            return;
        }

        const userQuery = document.getElementById('userQuery').value.trim();
        if (!userQuery) {
            alert("è¯·è¾“å…¥ç©å®¶æŸ¥è¯¢ï¼");
            return;
        }

        // è·å–è¾“å…¥å‚æ•°
        const npcInfo = {
            id: 'npc_test_01',
            name: document.getElementById('npcName').value || 'æœªçŸ¥',
            occupation: document.getElementById('npcOccupation').value || 'æœªçŸ¥',
            personality: document.getElementById('npcPersonality').value || 'æœªçŸ¥',
            desc: document.getElementById('npcDesc').value || ''
        };

        const playerStatus = {
            money: parseInt(document.getElementById('playerMoney').value) || 100,
            social: document.getElementById('playerSocial').value.split(',').map(s => s.trim()) || ['æ™®é€š'],
            physical: ['å¥åº·']
        };

        playerMoney = playerStatus.money;
        selectedItems = [];
        filteredItems = [];
        pricedItems = [];

        // æ›´æ–°UI
        document.getElementById('currentMoney').textContent = playerMoney;
        document.getElementById('processBtn').disabled = true;
        document.getElementById('btnText').textContent = 'â³ å¤„ç†ä¸­...';
        document.getElementById('loader').style.display = 'block';

        // æ˜¾ç¤ºæ‰€æœ‰è¾“å‡ºåŒºåŸŸ
        document.getElementById('llm1Section').style.display = 'block';
        document.getElementById('llm2Section').style.display = 'block';
        document.getElementById('itemSelectionSection').style.display = 'none';
        document.getElementById('purchaseSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'none';

        try {
            // ========== LLM #1: ç‰©å“è¿‡æ»¤LLM ==========
            document.getElementById('llm1Thinking').textContent = 'æ­£åœ¨è°ƒç”¨LLM #1...';
            document.getElementById('llm1Filters').textContent = 'ç­‰å¾…ä¸­...';

            const queryLogic = await itemFilter.fetchQueryLogic(userQuery, npcInfo);

            // æ˜¾ç¤ºæ€ç»´é“¾
            if (queryLogic.thinking) {
                document.getElementById('llm1Thinking').textContent = JSON.stringify(queryLogic.thinking, null, 2);
            } else {
                document.getElementById('llm1Thinking').textContent = 'æ— æ€ç»´é“¾æ•°æ®';
            }

            // æ˜¾ç¤ºè¿‡æ»¤é€»è¾‘
            const filtersOnly = { filters: queryLogic.filters };
            document.getElementById('llm1Filters').textContent = JSON.stringify(filtersOnly, null, 2);

            // æ‰§è¡Œè¿‡æ»¤
            const filtered = itemFilter.executeFilter(queryLogic);
            console.log(filtered);
            filteredItems = filtered;

            // æ˜¾ç¤ºè¿‡æ»¤åçš„ç‰©å“
            displayFilteredItems(filteredItems);

            // ========== LLM #2: å•†äººå®šä»·LLM ==========
            document.getElementById('llm2Thinking').textContent = 'æ­£åœ¨è°ƒç”¨LLM #2...';
            document.getElementById('llm2Pricing').textContent = 'ç­‰å¾…ä¸­...';

            const pricingResult = await itemFilter.callMerchantLLM(
                filteredItems,
                npcInfo,
                playerStatus,
                []
            );

            // æ˜¾ç¤ºæ€ç»´é“¾
            if (pricingResult.thinking) {
                document.getElementById('llm2Thinking').textContent = JSON.stringify(pricingResult.thinking, null, 2);
            } else {
                document.getElementById('llm2Thinking').textContent = 'æ— æ€ç»´é“¾æ•°æ®';
            }

            // æ˜¾ç¤ºå®šä»·ç»“æœ
            const pricingOnly = { items: pricingResult.items };
            document.getElementById('llm2Pricing').textContent = JSON.stringify(pricingOnly, null, 2);

            // ä¿å­˜å®šä»·ç»“æœ
            pricedItems = pricingResult.items || [];

            // æ˜¾ç¤ºç‰©å“é€‰æ‹©ç•Œé¢
            displayPricedItems(pricedItems);
            document.getElementById('itemSelectionSection').style.display = 'block';

        } catch (error) {
            console.error(error);
            alert("å¤„ç†å¤±è´¥: " + error.message);
        } finally {
            document.getElementById('processBtn').disabled = false;
            document.getElementById('btnText').textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
            document.getElementById('loader').style.display = 'none';
        }
    }

    function displayFilteredItems(items) {
        const container = document.getElementById('filteredItemsGrid');
        container.innerHTML = '';

        if (items.length === 0) {
            container.innerHTML = '<div style="grid-column: 1/-1; color:#888; text-align:center; padding:20px;">æ²¡æœ‰åŒ¹é…çš„ç‰©å“</div>';
            return;
        }

        items.slice(0, 20).forEach(item => {
            const card = document.createElement('div');
            card.className = 'filtered-item';
            card.innerHTML = `
                    <strong>${item.name}</strong><br>
                    <span style="color:#888;">ID: ${item.id}</span> |
                    <span style="color:#ffab00;">Â¥${item.price}</span> |
                    <span style="color:#666;">${item.weight}kg</span><br>
                    <span style="color:#00d4ff; font-size:0.8em;">${item.tags || 'æ— æ ‡ç­¾'}</span>
                `;
            container.appendChild(card);
        });

        document.getElementById('filteredItemsSection').style.display = 'block';
    }

    function displayPricedItems(items) {
        const container = document.getElementById('pricedItemsGrid');
        container.innerHTML = '';

        if (items.length === 0) {
            container.innerHTML = '<div style="grid-column: 1/-1; color:#888; text-align:center; padding:20px;">æ²¡æœ‰å¯è´­ä¹°çš„ç‰©å“</div>';
            return;
        }

        items.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.index = index;
            card.onclick = () => toggleItemSelection(index);

            const hasDiscount = item.final_price < item.base_price;
            const hasMarkup = item.final_price > item.base_price;

            card.innerHTML = `
                    <h4>${item.item_name}</h4>
                    <div>
                        ${hasDiscount ? `<span class="base-price">Â¥${item.base_price}</span>` : ''}
                        <span class="price">Â¥${item.final_price}</span>
                        ${hasMarkup ? `<span style="color:#f44336; font-size:0.8em;">â†‘</span>` : ''}
                        ${hasDiscount ? `<span style="color:#4CAF50; font-size:0.8em;">â†“</span>` : ''}
                    </div>
                    <div class="price-modifier">${item.price_modifier || 'æ— è°ƒæ•´'}</div>
                    <div style="font-size:0.8em; color:#666; margin-top:5px;">ID: ${item.item_id}</div>
                `;
            container.appendChild(card);
        });
    }

    function toggleItemSelection(index) {
        const item = pricedItems[index];
        const card = document.querySelector(`.item-card[data-index="${index}"]`);

        const existingIndex = selectedItems.findIndex(si => si.item_id === item.item_id);

        if (existingIndex >= 0) {
            // å–æ¶ˆé€‰æ‹©
            selectedItems.splice(existingIndex, 1);
            card.classList.remove('selected');
        } else {
            // é€‰æ‹©ç‰©å“
            selectedItems.push({
                ...item,
                quantity: 1
            });
            card.classList.add('selected');
        }

        updatePurchaseSummary();
    }

    function updatePurchaseSummary() {
        const container = document.getElementById('selectedItemsList');
        container.innerHTML = '';

        if (selectedItems.length === 0) {
            container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">æœªé€‰æ‹©ä»»ä½•ç‰©å“</div>';
            document.getElementById('purchaseSection').style.display = 'none';
            return;
        }

        let total = 0;
        selectedItems.forEach((item, index) => {
            const cost = item.final_price * (item.quantity || 1);
            total += cost;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'purchase-item';
            itemDiv.innerHTML = `
                    <div>
                        <strong>${item.item_name}</strong><br>
                        <span style="font-size:0.9em; color:#888;">æ•°é‡: ${item.quantity || 1}</span>
                    </div>
                    <div style="text-align:right;">
                        <div class="price">Â¥${cost.toFixed(2)}</div>
                        <div style="font-size:0.8em; color:#888;">å•ä»·: Â¥${item.final_price}</div>
                    </div>
                `;
            container.appendChild(itemDiv);
        });

        document.getElementById('totalPrice').textContent = total.toFixed(2);
        const remaining = playerMoney - total;
        document.getElementById('remainingMoney').textContent = remaining.toFixed(2);

        // æ›´æ–°é‡‘é’±çŠ¶æ€
        const moneyStatus = document.getElementById('moneyStatus');
        if (remaining < 0) {
            moneyStatus.innerHTML = '<span class="status-badge status-error">ğŸ’° ä½™é¢ä¸è¶³</span>';
        } else if (remaining < 100) {
            moneyStatus.innerHTML = '<span class="status-badge status-error">âš ï¸ ä½™é¢è¾ƒä½</span>';
        } else {
            moneyStatus.innerHTML = '<span class="status-badge status-success">âœ“ ä½™é¢å……è¶³</span>';
        }

        document.getElementById('purchaseSection').style.display = 'block';
    }

    function confirmPurchase() {
        const total = selectedItems.reduce((sum, item) => sum + (item.final_price * (item.quantity || 1)), 0);

        if (total > playerMoney) {
            alert('ä½™é¢ä¸è¶³ï¼Œæ— æ³•å®Œæˆè´­ä¹°ï¼');
            return;
        }

        if (selectedItems.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç‰©å“ï¼');
            return;
        }

        // æ‰§è¡Œè´­ä¹°
        playerMoney -= total;
        document.getElementById('currentMoney').textContent = playerMoney.toFixed(2);

        // æ˜¾ç¤ºè´­ä¹°ç»“æœ
        const resultContainer = document.getElementById('purchaseResult');
        let html = '<div style="color:#4CAF50; font-size:1.1em; margin-bottom:15px;">âœ… è´­ä¹°æˆåŠŸï¼</div>';

        html += '<div style="margin-bottom:15px;"><strong>è´­ä¹°çš„ç‰©å“ï¼š</strong></div>';
        selectedItems.forEach(item => {
            const cost = item.final_price * (item.quantity || 1);
            html += `
                    <div style="padding:10px; background:var(--card-bg); border-radius:4px; margin-bottom:10px;">
                        <strong>${item.item_name}</strong> Ã— ${item.quantity || 1}<br>
                        <span style="color:#888;">å•ä»·: Â¥${item.final_price}</span> |
                        <span style="color:#ffab00;">å°è®¡: Â¥${cost.toFixed(2)}</span>
                    </div>
                `;
        });

        html += `
                <div style="margin-top:15px; padding:15px; background:rgba(76,175,80,0.1); border-radius:4px;">
                    <div style="font-size:1.2em; font-weight:bold; color:#4CAF50;">
                        æ€»æ¶ˆè´¹: Â¥${total.toFixed(2)}
                    </div>
                    <div style="margin-top:10px;">
                        å‰©ä½™é‡‘é’±: <strong>Â¥${playerMoney.toFixed(2)}</strong> ä¿¡ç”¨ç‚¹
                    </div>
                </div>
            `;

        resultContainer.innerHTML = html;
        document.getElementById('resultSection').style.display = 'block';

        // æ»šåŠ¨åˆ°ç»“æœ
        document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
    }
</script>
</body>
</html>
