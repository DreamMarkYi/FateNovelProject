<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURO-DETECTIVE: Trinity Interface</title>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js"></script>

    <style>
        :root {
            --bg-color: #050a10;
            --panel-bg: #0f1623;
            --border-color: #233142;
            --accent-color: #00ffcc;
            --narrative-color: #ffcc00; /* 剧情图主色 */
            --loc-color: #4a9eff;       /* 地图主色 */
            --item-color: #d2a8ff;      /* 物品主色 */
            --text-color: #d0d7de;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', 'Roboto Mono', monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* 顶部 HUD */
        #hud-bar {
            background: rgba(15, 22, 35, 0.95);
            padding: 10px 20px;
            border-bottom: 2px solid var(--accent-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            height: 40px;
        }

        .mission-objective {
            font-size: 0.9rem;
            color: var(--narrative-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }

        /* 主布局 */
        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* 左侧：三个图谱的容器 */
        #graphs-column {
            flex: 2;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            background: #000;
        }

        .graph-section {
            flex: 1;
            position: relative;
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
        }
        .graph-section:last-child { border-bottom: none; }

        .graph-label {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 0.75rem;
            padding: 2px 8px;
            background: rgba(0,0,0,0.7);
            border-left: 3px solid;
            z-index: 10;
            pointer-events: none;
        }

        /* 定义每个图的视觉容器 */
        #viz-location { width: 100%; height: 100%; background: radial-gradient(circle at center, #0f1c2e 0%, #000 100%); }
        #viz-inventory { width: 100%; height: 100%; background: radial-gradient(circle at center, #1a0f2e 0%, #000 100%); }
        #viz-narrative { width: 100%; height: 100%; background: radial-gradient(circle at center, #2e260f 0%, #000 100%); }

        /* 右侧交互终端 */
        #terminal-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel-bg);
            max-width: 450px;
            border-left: 1px solid var(--border-color);
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* 消息样式 */
        .msg { padding: 10px; border-radius: 4px; font-size: 0.9rem; line-height: 1.5; max-width: 95%; position: relative; word-wrap: break-word;}
        .msg.ai { background: rgba(0, 255, 204, 0.05); border-left: 2px solid var(--accent-color); color: #fff; }
        .msg.user { background: rgba(255, 255, 255, 0.05); border-right: 2px solid #666; align-self: flex-end; text-align: right; }
        .msg.system { color: #666; font-size: 0.8rem; text-align: center; font-style: italic; }
        .msg.end { border: 1px solid var(--danger-color); color: #ff3366; text-align: center; font-weight: bold; background: rgba(255, 51, 102, 0.1); }

        /* 输入区 */
        #input-area {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.3);
        }

        input[type="text"] {
            flex: 1;
            background: rgba(0,0,0,0.5);
            border: 1px solid #333;
            color: var(--accent-color);
            padding: 10px;
            font-family: 'Roboto Mono', monospace;
        }
        input[type="text"]:focus { outline: none; border-color: var(--accent-color); }
        button {
            background: rgba(0, 255, 204, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            cursor: pointer;
            font-family: 'Roboto Mono', monospace;
        }
        button:hover { background: var(--accent-color); color: #000; }
        button:disabled { border-color: #444; color: #444; cursor: not-allowed; background: transparent;}

        /* Loading */
        .scanline {
            width: 100%; height: 2px; background: var(--accent-color);
            position: absolute; top: 0; left: 0; opacity: 0; z-index: 50; pointer-events: none;
        }
        .scanning .scanline { opacity: 1; animation: scan 1.5s infinite linear; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

    </style>
</head>
<body>

<div class="scanline" id="scan-effect"></div>

<div id="hud-bar">
    <div style="font-weight:900; letter-spacing:2px;">TRINITY<span style="color:var(--accent-color)">://</span>ENGINE</div>
    <div class="mission-objective" id="objective-display">任务目标: 初始化...</div>
    <div><button id="reset-btn" onclick="startGame()" style="font-size:0.7rem; padding:5px;">REBOOT</button></div>
</div>

<div id="main-container">
    <div id="graphs-column">
        <div class="graph-section">
            <div class="graph-label" style="border-color: var(--loc-color); color: var(--loc-color);">LOCATION MAP (位置拓扑)</div>
            <div id="viz-location"></div>
        </div>
        <div class="graph-section">
            <div class="graph-label" style="border-color: var(--item-color); color: var(--item-color);">INVENTORY LINK (神经链接)</div>
            <div id="viz-inventory"></div>
        </div>
        <div class="graph-section">
            <div class="graph-label" style="border-color: var(--narrative-color); color: var(--narrative-color);">NARRATIVE PATH (因果链)</div>
            <div id="viz-narrative"></div>
        </div>
    </div>

    <div id="terminal-panel">
        <div id="chat-history">
            <div class="msg system">>> SYSTEM ONLINE. 神经三位一体系统连接中...</div>
        </div>
        <div id="input-area">
            <input type="text" id="player-input" placeholder="输入指令 (e.g. 调查, 前往...)" autocomplete="off" disabled>
            <button id="send-btn" onclick="handleInput()" disabled>SEND</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. 配置 & 状态管理
    // ==========================================
    const API_CONFIG = {
        url: "https://api.mindcraft.com.cn/v1/chat/completions",
        key: "MC-E5B8AB237AAC4EDCBFA26531D6BE0081",
        model: "gemini-3-pro-preview"
    };

    // 数据结构：由三个独立的图组成
    const GRAPH_STORE = {
        location: { nodes: null, edges: null, network: null },
        inventory: { nodes: null, edges: null, network: null },
        narrative: { nodes: null, edges: null, network: null }
    };

    // 游戏初始设定
    const GAME_CONFIG = {
        victory_condition: "玩家在【天际线穿梭站】且破解了芯片。",
        display_objective: "目标: 逃离夜之城"
    };

    let conversationHistory = [];
    let isGameOver = false;
    let currentLocationId = 'loc_start'; // 追踪当前位置用于高亮

    // ==========================================
    // 2. Vis.js 初始化 (三个独立的图)
    // ==========================================

    function initOneGraph(containerId, optionsOverride = {}) {
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const container = document.getElementById(containerId);

        const defaultOptions = {
            nodes: {
                shape: 'dot', size: 15,
                font: { color: '#fff', size: 12, face: 'Roboto Mono' },
                borderWidth: 2, shadow: true
            },
            edges: {
                width: 1, color: { color: '#555', highlight: '#fff' },
                smooth: { type: 'dynamic' }
            },
            physics: {
                stabilization: false,
                barnesHut: { gravitationalConstant: -2000, springConstant: 0.04 }
            },
            interaction: { hover: true, zoomView: true }
        };

        const options = { ...defaultOptions, ...optionsOverride };
        // Deep merge for specific nested keys if needed (simplified here)
        if(optionsOverride.edges) options.edges = { ...defaultOptions.edges, ...optionsOverride.edges };

        const network = new vis.Network(container, { nodes, edges }, options);
        return { nodes, edges, network };
    }

    function initAllGraphs() {
        // 1. Location Map: 强调路径和当前位置 (有箭头)
        GRAPH_STORE.location = initOneGraph('viz-location', {
            edges: { arrows: 'to, from', color: '#4a9eff' }
        });

        // 2. Inventory: 强调连接组合 (无箭头，无向图)
        GRAPH_STORE.inventory = initOneGraph('viz-inventory', {
            edges: { arrows: undefined, color: '#d2a8ff' }, // 无向
            nodes: { shape: 'box', margin: 10 }
        });

        // 3. Narrative: 强调流程 (有箭头)
        GRAPH_STORE.narrative = initOneGraph('viz-narrative', {
            edges: { arrows: 'to', color: '#ffcc00', style: 'dash-line' },
            layout: { hierarchical: { direction: 'UD', sortMethod: 'directed', levelSeparation: 60 } }, // 层级布局
            physics: { hierarchicalRepulsion: { nodeDistance: 100 } }
        });
    }

    // ==========================================
    // 3. 提示词工程 (System + User Injection)
    // ==========================================

    // System Prompt: 仅包含世界观、角色职责和一般规则
    const SYSTEM_PROMPT = `
你是一个赛博朋克风格文字冒险游戏的后端引擎。
当前目标：${GAME_CONFIG.victory_condition}。

【世界规则】
1. **位置图 (Location)**：节点代表地点，连线代表通路。线上的文字是移动方式。必须高亮玩家当前位置。
2. **物品图 (Inventory)**：核心节点是"Player"。其他节点是物品。
   - "Player"与物品连线代表"持有"。
   - 物品与物品连线代表"组合/兼容"。
3. **剧情图 (Narrative)**：记录玩家的关键行动。
   - 节点是行动或事件（如"醒来"、"开枪"）。
   - 终点节点（Goal）初始时是孤立的，直到玩家达成条件才能连接。
   - 这是一张有向无环图，代表时间/因果流。

请根据玩家输入推进剧情，生动描写赛博朋克氛围。
`;

    // 动态生成 User Prompt 的后缀，包含严格的 JSON 格式要求
    function getJsonInstruction() {
        return `
\n\n[SYSTEM INSTRUCTION]
必须严格遵守以下 JSON 格式回复，不要包含 Markdown 格式标记：
{
  "narrative": "剧情描述文本 (支持HTML标签如 <br>)",
  "game_over": boolean,
  "ending_type": "VICTORY" | "DEFEAT" | null,
  "current_location_id": "当前玩家所在位置节点的ID (用于高亮)",
  "graph_ops": [
    {
      "domain": "location" | "inventory" | "narrative",
      "op": "add_node",
      "id": "unique_id", "label": "显示名", "desc": "描述",
      "color": "HEX色值 (Loc:#4a9eff, Item:#d2a8ff, Event:#ffcc00)"
    },
    {
      "domain": "location" | "inventory" | "narrative",
      "op": "add_edge",
      "from": "id", "to": "id", "label": "连线文字"
    },
    { "domain": "...", "op": "remove_node", "id": "..." }
  ]
}
`;
    }

    // 获取当前三个图的状态快照发送给 AI
    function getGraphContext() {
        const snap = {};
        ['location', 'inventory', 'narrative'].forEach(key => {
            snap[key] = {
                nodes: GRAPH_STORE[key].nodes.get().map(n => ({id: n.id, label: n.label})),
                edges: GRAPH_STORE[key].edges.get().map(e => ({from: e.from, to: e.to, label: e.label}))
            };
        });
        return `[Current Graph State]: ${JSON.stringify(snap)}`;
    }

    // ==========================================
    // 4. LLM 通信 & 处理
    // ==========================================

    async function callLLM(userAction, isInit = false) {
        const loading = document.getElementById('scan-effect');
        loading.classList.add('scanning');

        // 构造 User Message：上下文 + 用户输入 + 格式指令
        const contextStr = getGraphContext();
        const instructionStr = getJsonInstruction();

        let userContent = "";
        if (isInit) {
            userContent = `初始化游戏。创建三个图的初始状态：
            1. Loc: 起点(贫民窟), 终点(天际线车站, 孤立).
            2. Inv: 玩家节点, 初始物品(芯片).
            3. Nar: 起始事件(苏醒), 最终目标节点(逃离, 孤立).
            描述开场。` + instructionStr;
        } else {
            userContent = `[Context] ${contextStr}\n\n[Player Action] ${userAction}` + instructionStr;
        }

        const messages = [
            { role: "system", content: SYSTEM_PROMPT },
            ...conversationHistory,
            { role: "user", content: userContent }
        ];

        try {
            const response = await fetch(API_CONFIG.url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${API_CONFIG.key}`
                },
                body: JSON.stringify({
                    model: API_CONFIG.model,
                    messages: messages,
                    temperature: 0.7,
                    response_format: { type: "json_object" }
                })
            });

            if (!response.ok) throw new Error("Net Error");
            const data = await response.json();
            const cleanContent = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            const result = JSON.parse(cleanContent);

            // 只有非初始化才记录用户历史
            if (!isInit) conversationHistory.push({ role: "user", content: userAction });
            // 记录AI回复（为了节省token，可以不存完整的json，只存narrative，但为了上下文连贯建议存简略版）
            conversationHistory.push({ role: "assistant", content: result.narrative });

            // 滚动上下文窗口 (保留最近 4 轮)
            if (conversationHistory.length > 8) conversationHistory = [conversationHistory[0], ...conversationHistory.slice(-7)];

            return result;
        } catch (error) {
            console.error(error);
            appendLog(`System Error: ${error.message}`, 'system');
            return null;
        } finally {
            loading.classList.remove('scanning');
        }
    }

    // 处理回复核心逻辑
    function processGameResponse(data) {
        if (!data) return;

        // 1. 剧情文本
        appendLog(data.narrative, 'ai');

        // 2. 更新当前位置 ID (用于高亮)
        if (data.current_location_id) {
            currentLocationId = data.current_location_id;
        }

        // 3. 执行图谱操作
        if (data.graph_ops) {
            data.graph_ops.forEach(op => executeOp(op));
        }

        // 4. 刷新位置高亮
        highlightLocationNode();

        // 5. 结局判定
        if (data.game_over) {
            isGameOver = true;
            const endMsg = data.ending_type === 'VICTORY' ? "任务完成 // 逃离成功" : "信号丢失 // 死亡";
            appendLog(endMsg, 'end');
            toggleInputs(false);
            document.getElementById('player-input').placeholder = "SYSTEM HALTED.";
        }
    }

    // 执行单个图谱操作
    function executeOp(op) {
        const domain = op.domain; // 'location', 'inventory', 'narrative'
        if (!GRAPH_STORE[domain]) return;

        const { nodes, edges } = GRAPH_STORE[domain];

        try {
            if (op.op === 'add_node') {
                if (!nodes.get(op.id)) {
                    nodes.add({
                        id: op.id,
                        label: op.label,
                        title: op.desc, // tooltip
                        color: op.color || getColorByDomain(domain)
                    });
                }
            } else if (op.op === 'add_edge') {
                // 检查是否已存在
                const exists = edges.get({ filter: e => e.from === op.from && e.to === op.to });
                if (exists.length === 0) {
                    edges.add({ from: op.from, to: op.to, label: op.label });
                }
            } else if (op.op === 'remove_node') {
                nodes.remove(op.id);
            }
        } catch (e) {
            console.warn("Op failed:", op, e);
        }
    }

    function getColorByDomain(domain) {
        if (domain === 'location') return '#4a9eff';
        if (domain === 'inventory') return '#d2a8ff';
        if (domain === 'narrative') return '#ffcc00';
        return '#fff';
    }

    // 高亮当前位置节点，暗化其他位置
    function highlightLocationNode() {
        const nodes = GRAPH_STORE.location.nodes;
        const allIds = nodes.getIds();

        const updates = allIds.map(id => {
            const isCurrent = (id === currentLocationId);
            return {
                id: id,
                color: isCurrent ? '#00ffcc' : '#4a9eff', // 当前位置青色，其他蓝色
                shadow: isCurrent ? { enabled: true, color: '#00ffcc', size: 20 } : { enabled: false }
            };
        });
        nodes.update(updates);

        // 聚焦相机
        if (currentLocationId) {
            GRAPH_STORE.location.network.fit({ nodes: [currentLocationId], animation: true });
        }
    }

    // ==========================================
    // 5. UI 交互杂项
    // ==========================================

    function appendLog(html, type) {
        const box = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = html;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    async function handleInput() {
        if (isGameOver) return;
        const input = document.getElementById('player-input');
        const val = input.value.trim();
        if (!val) return;

        appendLog(val, 'user');
        input.value = '';
        toggleInputs(false);

        const result = await callLLM(val);
        processGameResponse(result);

        if (!isGameOver) toggleInputs(true);
    }

    function toggleInputs(enabled) {
        document.getElementById('player-input').disabled = !enabled;
        document.getElementById('send-btn').disabled = !enabled;
        if (enabled) document.getElementById('player-input').focus();
    }

    async function startGame() {
        isGameOver = false;
        conversationHistory = [];
        currentLocationId = 'loc_start';

        // 清空所有图
        Object.values(GRAPH_STORE).forEach(g => {
            if(g.nodes) g.nodes.clear();
            if(g.edges) g.edges.clear();
        });

        document.getElementById('chat-history').innerHTML = '<div class="msg system">>> 初始化神经连接... 生成三维拓扑...</div>';
        toggleInputs(false);

        // 启动请求
        const result = await callLLM(null, true);
        processGameResponse(result);

        toggleInputs(true);
    }

    // 绑定回车
    document.getElementById('player-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleInput();
    });

    window.onload = function() {
        initAllGraphs();
        startGame();
    };

</script>
</body>
</html>