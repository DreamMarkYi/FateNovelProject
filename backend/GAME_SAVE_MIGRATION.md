# æ¸¸æˆå­˜æ¡£ç³»ç»Ÿé‡æ„è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡é‡æ„å°†æ¸¸æˆå­˜æ¡£ç³»ç»Ÿä» **"æ¯ä¸ªå­˜æ¡£ä¸€æ¡è®°å½•"** æ”¹ä¸º **"æ¯ä¸ªç”¨æˆ·ä¸€æ¡è®°å½•"** çš„æ¨¡å¼ã€‚

### æ—§ç»“æ„ vs æ–°ç»“æ„

| ç‰¹æ€§ | æ—§ç»“æ„ | æ–°ç»“æ„ |
|------|--------|--------|
| è®°å½•æ•°é‡ | æ¯ä¸ªå­˜æ¡£ä¸€æ¡ | æ¯ä¸ªç”¨æˆ·ä¸€æ¡ |
| æŸ¥è¯¢æ•ˆç‡ | ä½ï¼ˆéœ€è¦å¤šæ¬¡æŸ¥è¯¢ï¼‰ | é«˜ï¼ˆä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰å­˜æ¡£ï¼‰ |
| æ•°æ®å…³è” | å¼±ï¼ˆéš¾ä»¥è·¨å­˜æ¡£ç»Ÿè®¡ï¼‰ | å¼ºï¼ˆç”¨æˆ·ç»´åº¦æ•°æ®èšåˆï¼‰ |
| ç´¢å¼•æ•ˆç‡ | playerId + saveSlot å¤åˆç´¢å¼• | playerId å”¯ä¸€ç´¢å¼• |

**ç¤ºä¾‹å¯¹æ¯”ï¼š**

```
æ—§ç»“æ„ - 3ä¸ªå­˜æ¡£ = 3æ¡è®°å½•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ playerIdâ”‚ saveSlot â”‚ saveData   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user123 â”‚    1     â”‚ {...}      â”‚
â”‚ user123 â”‚    2     â”‚ {...}      â”‚
â”‚ user123 â”‚   99     â”‚ {...}      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–°ç»“æ„ - 3ä¸ªå­˜æ¡£ = 1æ¡è®°å½•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ playerIdâ”‚ saves (Map)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user123 â”‚ {                           â”‚
â”‚         â”‚   "1": { saveData },        â”‚
â”‚         â”‚   "2": { saveData },        â”‚
â”‚         â”‚   "99": { saveData }        â”‚
â”‚         â”‚ }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ–°ç»“æ„è¯¦è§£

### Schema è®¾è®¡

```javascript
{
  playerId: String (unique),           // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  playerName: String,                  // ç”¨æˆ·åç§°
  
  // æ‰€æœ‰å­˜æ¡£æ§½ä½ï¼ˆMapç»“æ„ï¼‰
  saves: {
    "1": { saveData },   // æ‰‹åŠ¨å­˜æ¡£æ§½ä½1
    "2": { saveData },   // æ‰‹åŠ¨å­˜æ¡£æ§½ä½2
    ...
    "98": { saveData },  // è‡ªåŠ¨å­˜æ¡£ï¼ˆå›ºå®šï¼‰
    "99": { saveData }   // å¿«é€Ÿå­˜æ¡£ï¼ˆå›ºå®šï¼‰
  },
  
  // å…¨å±€å·²è¯»åœºæ™¯ï¼ˆè·¨å­˜æ¡£ï¼‰
  globalReadScenes: [1, 2, 5, 10, ...],
  
  // å…¨å±€è§£é”å†…å®¹ï¼ˆè·¨å­˜æ¡£ï¼‰
  globalUnlockedContent: {
    cg: ["cg_01", "cg_02"],
    achievements: ["ach_01"],
    endings: ["day_ending", "night_ending"]
  },
  
  // å…ƒæ•°æ®
  metadata: {
    totalSaves: 5,              // æ€»å­˜æ¡£æ•°
    lastPlayedAt: Date,         // æœ€åæ¸¸ç©æ—¶é—´
    totalPlayTime: 3600,        // æ€»æ¸¸æˆæ—¶é•¿ï¼ˆç§’ï¼‰
    gameVersion: "1.0.0"        // æ¸¸æˆç‰ˆæœ¬
  }
}
```

### å•ä¸ªå­˜æ¡£æ•°æ®ç»“æ„

```javascript
{
  saveName: "å­˜æ¡£ 1",
  description: "ç”¨æˆ·å¤‡æ³¨",
  scriptId: "chapter1-1",
  scriptName: "ç¬¬ä¸€ç« ",
  currentSceneIndex: 42,
  screenshot: "https://...",
  sceneSnapshot: {
    speaker: "è§’è‰²å",
    text: "å¯¹è¯å†…å®¹",
    bgImage: "èƒŒæ™¯å›¾",
    timestamp: Date
  },
  progressPercentage: 65,
  gameVariables: Map<String, Any>,
  choiceHistory: [{ choice data }],
  readScenes: [1, 2, 3, 5, 10],
  unlockedContent: {
    cg: ["cg_01"],
    achievements: [],
    endings: []
  },
  playTime: 1200,
  isAutoSave: false,
  isQuickSave: false,
  isValid: true,
  savedAt: Date
}
```

---

## ğŸš€ æ•°æ®è¿ç§»

### è¿è¡Œè¿ç§»è„šæœ¬

```bash
# 1. å¤‡ä»½æ•°æ®åº“ï¼ˆå¼ºçƒˆå»ºè®®ï¼ï¼‰
mongodump --db fate_novel --out ./backup

# 2. è¿è¡Œè¿ç§»è„šæœ¬
cd backend
node src/scripts/migrateGameSaves.js
```

### è¿ç§»æµç¨‹

1. **å¤‡ä»½æ—§è¡¨**ï¼š`game_saves` â†’ `game_saves_old`
2. **è¯»å–æ—§æ•°æ®**ï¼šä» `game_saves_old` è¯»å–æ‰€æœ‰è®°å½•
3. **æŒ‰ç”¨æˆ·åˆ†ç»„**ï¼šå°†å­˜æ¡£æŒ‰ `playerId` åˆ†ç»„
4. **åˆ›å»ºæ–°è®°å½•**ï¼šä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸€æ¡æ–°è®°å½•
5. **è¿ç§»å­˜æ¡£æ•°æ®**ï¼šå°†æ‰€æœ‰å­˜æ¡£æ§½ä½è¿ç§»åˆ° `saves` Map
6. **èšåˆå…¨å±€æ•°æ®**ï¼šæ”¶é›†è·¨å­˜æ¡£çš„å·²è¯»åœºæ™¯å’Œè§£é”å†…å®¹

### å›æ»šæ“ä½œ

å¦‚æœè¿ç§»å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°æ—§ç»“æ„ï¼š

```javascript
// MongoDB Shell
use fate_novel;
db.game_saves.drop();                      // åˆ é™¤æ–°è¡¨
db.game_saves_old.renameCollection("game_saves");  // æ¢å¤æ—§è¡¨
```

---

## ğŸ“Š API å˜åŒ–

### å‰ç«¯ API - æ— å˜åŒ–ï¼

å‰ç«¯ API æ¥å£ä¿æŒå®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ï¼š

```javascript
// âœ… è¿™äº› API è°ƒç”¨ä¿æŒä¸å˜
gameSaveApi.getPlayerSaves(playerId)
gameSaveApi.getSaveBySlot(playerId, slot)
gameSaveApi.saveGame(playerId, slot, data)
gameSaveApi.quickSave(playerId, data)
gameSaveApi.autoSave(playerId, data)
```

### åç«¯å®ç° - é‡æ„

åç«¯ Controller å·²å®Œå…¨é‡æ„ä»¥é€‚é…æ–°ç»“æ„ï¼š

**æ—§å®ç°ï¼ˆå¤šæ¡è®°å½•ï¼‰ï¼š**
```javascript
// æŸ¥è¯¢æ‰€æœ‰å­˜æ¡£
const saves = await GameSave.find({ playerId });
```

**æ–°å®ç°ï¼ˆå•æ¡è®°å½•ï¼‰ï¼š**
```javascript
// æŸ¥è¯¢ç”¨æˆ·å­˜æ¡£è®°å½•
const playerSaves = await GameSave.findOne({ playerId });
const saves = playerSaves.getAllSaves();
```

---

## ğŸ¯ ä¼˜åŠ¿

### 1. æ€§èƒ½æå‡

**æŸ¥è¯¢ä¼˜åŒ–ï¼š**
- æ—§ï¼šæŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰å­˜æ¡£éœ€è¦æ‰«æå¤šæ¡è®°å½•
- æ–°ï¼šä¸€æ¬¡æŸ¥è¯¢è·å–ç”¨æˆ·æ‰€æœ‰æ•°æ®

**ç¤ºä¾‹ï¼š**
```javascript
// æ—§æ–¹å¼ - å¤šæ¬¡æŸ¥è¯¢
const save1 = await GameSave.findOne({ playerId, saveSlot: 1 });
const save2 = await GameSave.findOne({ playerId, saveSlot: 2 });
const save99 = await GameSave.findOne({ playerId, saveSlot: 99 });

// æ–°æ–¹å¼ - ä¸€æ¬¡æŸ¥è¯¢
const playerSaves = await GameSave.findOne({ playerId });
const save1 = playerSaves.getSave(1);
const save2 = playerSaves.getSave(2);
const save99 = playerSaves.getQuickSave();
```

### 2. æ•°æ®èšåˆ

**å…¨å±€æ•°æ®ç»Ÿè®¡ï¼š**
- è·¨å­˜æ¡£çš„å·²è¯»åœºæ™¯è¿½è¸ª
- å…¨å±€æˆå°±å’Œè§£é”å†…å®¹
- ç”¨æˆ·æ€»æ¸¸æˆæ—¶é•¿ç»Ÿè®¡

**ç¤ºä¾‹ï¼š**
```javascript
// è·å–ç”¨æˆ·æ€»æ¸¸æˆæ—¶é•¿
const playerSaves = await GameSave.findOne({ playerId });
console.log(playerSaves.metadata.totalPlayTime); // æ‰€æœ‰å­˜æ¡£çš„æ€»æ—¶é•¿

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦çœ‹è¿‡æŸä¸ªåœºæ™¯ï¼ˆä»»æ„å­˜æ¡£ï¼‰
const hasReadScene = playerSaves.isSceneGlobalRead(42);
```

### 3. å­˜å‚¨ä¼˜åŒ–

**å‡å°‘è®°å½•æ•°ï¼š**
- 1000ä¸ªç”¨æˆ· Ã— 5ä¸ªå­˜æ¡£/ç”¨æˆ· = 5000æ¡è®°å½• â†’ **1000æ¡è®°å½•**
- ç´¢å¼•æ•°é‡å‡å°‘ 60%+
- æ•°æ®åº“å¤§å°å¯èƒ½å‡å°‘ 20-30%ï¼ˆå‡å°‘é‡å¤å…ƒæ•°æ®ï¼‰

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### ä¿å­˜æ¸¸æˆ

```javascript
// Controller è‡ªåŠ¨å¤„ç†ç”¨æˆ·è®°å½•çš„æŸ¥æ‰¾æˆ–åˆ›å»º
const response = await gameSaveApi.saveGame(playerId, 1, {
  scriptId: 'chapter1-1',
  currentSceneIndex: 42,
  gameVariables: { choice_5: 1 },
  choiceHistory: [...]
});

// åç«¯å¤„ç†ï¼š
// 1. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·è®°å½•
// 2. æ›´æ–°æ§½ä½1çš„å­˜æ¡£æ•°æ®
// 3. æ›´æ–°å…¨å±€å·²è¯»åœºæ™¯
// 4. ä¿å­˜æ•´ä¸ªç”¨æˆ·è®°å½•
```

### è·å–æ‰€æœ‰å­˜æ¡£

```javascript
const response = await gameSaveApi.getPlayerSaves(playerId);

// è¿”å›æ ¼å¼ï¼ˆä¸æ—§ API å…¼å®¹ï¼‰ï¼š
{
  success: true,
  data: [
    { saveSlot: 1, saveName: "å­˜æ¡£1", ... },
    { saveSlot: 2, saveName: "å­˜æ¡£2", ... },
    { saveSlot: 98, saveName: "è‡ªåŠ¨å­˜æ¡£", isAutoSave: true },
    { saveSlot: 99, saveName: "å¿«é€Ÿå­˜æ¡£", isQuickSave: true }
  ],
  count: 4,
  metadata: {
    totalSaves: 4,
    lastPlayedAt: "2025-12-10T...",
    totalPlayTime: 3600
  }
}
```

### åˆ é™¤å­˜æ¡£

```javascript
// åˆ é™¤æŒ‡å®šæ§½ä½
await gameSaveApi.deleteSave(playerId, 1);

// åç«¯å¤„ç†ï¼š
// 1. æŸ¥æ‰¾ç”¨æˆ·è®°å½•
// 2. ä» saves Map ä¸­åˆ é™¤æ§½ä½1
// 3. æ›´æ–° metadata.totalSaves
// 4. ä¿å­˜
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§

- è¿ç§»å‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
- è¿ç§»åéªŒè¯æ•°æ®å®Œæ•´æ€§
- ä¿ç•™æ—§è¡¨ `game_saves_old` è‡³å°‘ä¸€å‘¨

### 2. å†…å­˜ä½¿ç”¨

- æ¯ä¸ªç”¨æˆ·è®°å½•å¯èƒ½åŒ…å«å¤šä¸ªå­˜æ¡£ï¼ˆé€šå¸¸ â‰¤ 10ä¸ªï¼‰
- å•ä¸ªæ–‡æ¡£å¤§å°ä¼°ç®—ï¼šåŸºç¡€æ•°æ® (~10KB) + å­˜æ¡£æ•° Ã— å¹³å‡å­˜æ¡£å¤§å° (~50KB)
- å…¸å‹ç”¨æˆ·è®°å½•ï¼š10KB + 5 Ã— 50KB = ~260KB
- MongoDB å•æ–‡æ¡£é™åˆ¶ï¼š16MBï¼ˆè¿œè¶…å®é™…éœ€æ±‚ï¼‰

### 3. å¹¶å‘æ§åˆ¶

æ–°ç»“æ„ä¸‹ï¼Œå¯¹åŒä¸€ç”¨æˆ·çš„å¹¶å‘å­˜æ¡£æ“ä½œéœ€è¦æ³¨æ„ï¼š

```javascript
// âŒ é”™è¯¯ï¼šå¹¶å‘ä¿®æ”¹å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
Promise.all([
  saveToSlot(playerId, 1, data1),
  saveToSlot(playerId, 2, data2)
]);

// âœ… æ­£ç¡®ï¼šä¸²è¡Œæ“ä½œæˆ–ä½¿ç”¨äº‹åŠ¡
await saveToSlot(playerId, 1, data1);
await saveToSlot(playerId, 2, data2);
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•

- [ ] åˆ›å»ºæ–°å­˜æ¡£
- [ ] æ›´æ–°ç°æœ‰å­˜æ¡£
- [ ] åˆ é™¤å­˜æ¡£
- [ ] å¿«é€Ÿå­˜æ¡£/è¯»æ¡£
- [ ] è‡ªåŠ¨å­˜æ¡£
- [ ] è·å–å­˜æ¡£åˆ—è¡¨
- [ ] è·¨å­˜æ¡£æ•°æ®ï¼ˆå…¨å±€å·²è¯»ï¼‰

### æ€§èƒ½æµ‹è¯•

```javascript
// æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
console.time('è·å–ç”¨æˆ·æ‰€æœ‰å­˜æ¡£');
const saves = await gameSaveApi.getPlayerSaves(playerId);
console.timeEnd('è·å–ç”¨æˆ·æ‰€æœ‰å­˜æ¡£');

// é¢„æœŸï¼š< 50msï¼ˆæœ¬åœ°ï¼‰, < 200msï¼ˆè¿œç¨‹ï¼‰
```

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. è¿ç§»æ—¥å¿—è¾“å‡º
2. MongoDB æ—¥å¿—
3. åº”ç”¨ç¨‹åºæ—¥å¿—ï¼ˆcontroller å±‚ï¼‰
4. å¤‡ä»½æ•°æ®å®Œæ•´æ€§

**å¸¸è§é—®é¢˜ï¼š**

Q: è¿ç§»åæ—§å­˜æ¡£æ¶ˆå¤±äº†ï¼Ÿ
A: æ£€æŸ¥ `game_saves_old` è¡¨æ˜¯å¦å­˜åœ¨ï¼Œä½¿ç”¨å›æ»šå‘½ä»¤æ¢å¤ã€‚

Q: æ€§èƒ½åè€Œå˜æ…¢äº†ï¼Ÿ
A: ç¡®ä¿ `playerId` å­—æ®µæœ‰å”¯ä¸€ç´¢å¼•ï¼Œæ£€æŸ¥æŸ¥è¯¢æ–¹å¼æ˜¯å¦æ­£ç¡®ã€‚

Q: å‰ç«¯æŠ¥é”™ 404ï¼Ÿ
A: æ£€æŸ¥ API è·¯ç”±æ˜¯å¦æ­£ç¡®ï¼ŒJWT Token æ˜¯å¦æœ‰æ•ˆã€‚

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡é‡æ„å¸¦æ¥äº†ï¼š

âœ… **æ›´é«˜çš„æŸ¥è¯¢æ•ˆç‡**ï¼ˆä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®ï¼‰  
âœ… **æ›´å¥½çš„æ•°æ®èšåˆ**ï¼ˆç”¨æˆ·ç»´åº¦çš„å…¨å±€ç»Ÿè®¡ï¼‰  
âœ… **æ›´å°‘çš„æ•°æ®åº“è®°å½•**ï¼ˆå‡å°‘ 80%+ï¼‰  
âœ… **å®Œå…¨çš„æ¥å£å…¼å®¹**ï¼ˆå‰ç«¯æ— éœ€ä¿®æ”¹ï¼‰  
âœ… **æ›´å¼ºçš„æ‰©å±•æ€§**ï¼ˆä¾¿äºæ·»åŠ ç”¨æˆ·ç»´åº¦åŠŸèƒ½ï¼‰

è¿ç§»å®Œæˆåï¼Œç³»ç»Ÿå°†æ›´åŠ é«˜æ•ˆå’Œæ˜“äºç»´æŠ¤ï¼ğŸš€


